---
- name: Get contents of clouds.yaml
  ansible.builtin.slurp:
    src: /etc/kolla/clouds.yaml
  register: clouds_yaml

- name: Query dashboard and check that the returned page looks like a login page
  vars:
    clouds: "{{ clouds_yaml['content'] | b64decode | from_yaml }}"
    url_scheme: "{{ clouds.clouds['kolla-admin'].auth.auth_url | urlsplit('scheme') }}"
    url_host: "{{ kolla_external_vip_address | default(kolla_internal_vip_address) }}"
  ansible.builtin.uri:
    url: "{{ url_scheme + '://' + url_host }}"
    ca_path: "{{ clouds.clouds['kolla-admin'].cacert | default(omit) }}"
    follow_redirects: "all"
    return_content: true
    validate_certs: "{{ 'false' if scenario == 'lets-encrypt' else 'true' }}"
  register: dashboard_output
  until: dashboard_output.content.find('Login') != -1
  retries: 30
  delay: 10
